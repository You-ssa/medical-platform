<div class="dashboard-layout">
  <app-sidebar></app-sidebar>

  <div class="main-content">
    <app-header></app-header>

    <div class="page-content">

      <!-- En-tête -->
      <div class="page-header">
        <div>
          <h1><i class="fas fa-user-tie"></i> Gestion des Secrétaires</h1>
          <p class="page-subtitle">Gérez les secrétaires approuvé(e)s et les demandes en attente</p>
        </div>
      </div>

      <!-- Onglets -->
      <div class="admin-tabs">
        <button class="tab-btn"
          [class.active]="activeTab === 'en_attente'"
          (click)="activeTab = 'en_attente'; loadSecretairesEnAttente()">
          <i class="fas fa-hourglass-half"></i> En attente de validation
          <span class="badge badge-warning" *ngIf="secretairesEnAttente.length > 0">
            {{ secretairesEnAttente.length }}
          </span>
        </button>
        <button class="tab-btn"
          [class.active]="activeTab === 'approuves'"
          (click)="activeTab = 'approuves'; loadSecretaires()">
          <i class="fas fa-user-check"></i> Secrétaires approuvé(e)s
          <span class="badge" *ngIf="secretaires.length > 0">{{ secretaires.length }}</span>
        </button>
      </div>

      <!-- ══════════════════════════════════════════════════════
           ONGLET : En attente
           ══════════════════════════════════════════════════════ -->
      <div *ngIf="activeTab === 'en_attente'" class="validation-section">

        <!-- Barre d'outils spécifique pour l'onglet en attente -->
        <div class="toolbar">
          <div class="search-box" style="flex: 1;">
            <i class="fas fa-search"></i>
            <input type="text" [(ngModel)]="searchTerm"
                   (input)="searchSecretaires()"
                   placeholder="Rechercher un(e) secrétaire en attente...">
          </div>
          
          <button class="btn-export" (click)="exportEnAttenteToCSV()" [disabled]="exportingEnAttente">
            <i class="fas fa-download"></i> Exporter en attente
            <span *ngIf="exportingEnAttente" class="spinner-small"></span>
          </button>

          <button class="btn-import" (click)="triggerFileInputEnAttente()" [disabled]="importingEnAttente">
            <i class="fas fa-upload"></i> Importer en attente
            <span *ngIf="importingEnAttente" class="spinner-small"></span>
          </button>

          <input #fileInputEnAttente type="file" accept=".csv, .xlsx, .xls" style="display: none" (change)="onFileSelectedEnAttente($event)">
        </div>

        <div *ngIf="loadingEnAttente" class="loading-container">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Chargement des demandes...</p>
        </div>

        <div *ngIf="!loadingEnAttente && errorEnAttente" class="error-banner">
          <i class="fas fa-exclamation-triangle"></i> {{ errorEnAttente }}
          <button (click)="loadSecretairesEnAttente()">Réessayer</button>
        </div>

        <div *ngIf="!loadingEnAttente && !errorEnAttente && secretairesEnAttente.length === 0"
             class="empty-state">
          <i class="fas fa-check-circle"></i>
          <h3>Aucune demande en attente</h3>
          <p>Toutes les secrétaires ont été traitées.</p>
        </div>

        <div *ngIf="!loadingEnAttente && secretairesEnAttente.length > 0" class="users-grid">
          <div *ngFor="let secretaire of secretairesEnAttente" class="user-card">

            <div class="user-photo" (click)="showProfilDetail(secretaire)">
              <img [src]="getPhotoSrc(secretaire.photoBase64)" alt="Photo du/de la secrétaire">
              <div class="photo-overlay"><i class="fas fa-eye"></i></div>
            </div>

            <div class="user-info">
              <h3>{{ secretaire.prenom }} {{ secretaire.nom }}</h3>
              <p><i class="fas fa-stethoscope"></i> {{ secretaire.specialite || '—' }}</p>
              <p><i class="fas fa-briefcase"></i> {{ secretaire.poste || '—' }}</p>
              <p><i class="fas fa-envelope"></i> {{ secretaire.email }}</p>
              <p><i class="fas fa-phone"></i> {{ secretaire.telephone }}</p>
              <p><i class="fas fa-hospital"></i> {{ secretaire.adresseHopital || '—' }}</p>
              <p class="date">
                <i class="fas fa-calendar"></i>
                Inscrit(e) le {{ formatDate(secretaire.dateInscription!) }}
              </p>
            </div>

            <div class="user-actions">
              <button class="btn-view" (click)="showProfilDetail(secretaire)">
                <i class="fas fa-eye"></i> Voir le profil
              </button>
              <button class="btn-approve" (click)="approuverSecretaire(secretaire.id!)">
                <i class="fas fa-check"></i> Approuver
              </button>
              <button class="btn-reject" (click)="refuserSecretaire(secretaire.id!)">
                <i class="fas fa-times"></i> Refuser
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- ══════════════════════════════════════════════════════
           ONGLET : Approuvé(e)s
           ══════════════════════════════════════════════════════ -->
      <div *ngIf="activeTab === 'approuves'">

        <!-- Barre d'outils spécifique pour l'onglet approuvés -->
        <div class="toolbar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" [(ngModel)]="searchTerm"
                   (input)="searchSecretaires()"
                   placeholder="Rechercher un(e) secrétaire...">
          </div>
          
          <select class="filter-select" [(ngModel)]="filterSpecialite" (change)="filterBySpecialite()">
            <option value="">Toutes les spécialités</option>
            <option *ngFor="let spec of specialites" [value]="spec">{{ spec }}</option>
          </select>

          <button class="btn-export" (click)="exportApprouvesToCSV()" [disabled]="exportingApprouves">
            <i class="fas fa-download"></i> Exporter approuvés
            <span *ngIf="exportingApprouves" class="spinner-small"></span>
          </button>

          <button class="btn-import" (click)="triggerFileInputApprouves()" [disabled]="importingApprouves">
            <i class="fas fa-upload"></i> Importer approuvés
            <span *ngIf="importingApprouves" class="spinner-small"></span>
          </button>

          <input #fileInputApprouves type="file" accept=".csv, .xlsx, .xls" style="display: none" (change)="onFileSelectedApprouves($event)">
        </div>

        <!-- Grille des spécialités avec bouton Voir plus / Voir moins (5 premières) -->
        <div class="specialites-grid">
          <div *ngFor="let spec of (showAllSpecialites ? specialites : specialites.slice(0, 5))" class="specialite-card">
            <i class="fas fa-stethoscope"></i>
            <div>
              <p class="spec-name">{{ spec }}</p>
              <p class="spec-count">{{ getSpecialiteCount(spec) }} secrétaire{{ getSpecialiteCount(spec) > 1 ? 's' : '' }}</p>
            </div>
          </div>
        </div>

        <!-- Bouton Voir plus / Voir moins -->
        <div class="specialites-actions" *ngIf="specialites.length > 5">
          <button class="btn-link" (click)="toggleSpecialites()">
            <i class="fas fa-chevron-{{ showAllSpecialites ? 'up' : 'down' }}"></i>
            {{ showAllSpecialites ? 'Voir moins' : 'Voir plus (' + (specialites.length - 5) + ' autres)' }}
          </button>
        </div>

        <div *ngIf="loading" class="loading-container">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Chargement des secrétaires...</p>
        </div>

        <div *ngIf="!loading" class="medecins-grid">
          <div *ngFor="let secretaire of filteredSecretaires" class="medecin-card">

            <div class="card-header">
              <img [src]="getPhotoSrc(secretaire.photoBase64)"
                   alt="Photo" class="medecin-photo">
              <span class="status-badge active">Actif</span>
            </div>

            <div class="card-body">
              <h3>{{ secretaire.prenom }} {{ secretaire.nom }}</h3>
              <p class="specialite">
                <i class="fas fa-briefcase"></i> {{ secretaire.poste || '—' }}
              </p>
              <div class="info-list">
                <div class="info-row">
                  <i class="fas fa-stethoscope"></i>
                  <span>{{ secretaire.specialite || '—' }}</span>
                </div>
                <div class="info-row">
                  <i class="fas fa-envelope"></i>
                  <span>{{ secretaire.email }}</span>
                </div>
                <div class="info-row">
                  <i class="fas fa-phone"></i>
                  <span>{{ secretaire.telephone }}</span>
                </div>
                <div class="info-row">
                  <i class="fas fa-hospital"></i>
                  <span>{{ secretaire.adresseHopital || '—' }}</span>
                </div>
              </div>
            </div>

            <div class="card-footer">
              <button class="btn-card blue" (click)="viewSecretaire(secretaire)">
                <i class="fas fa-eye"></i> Détails
              </button>
              <button class="btn-card green">
                <i class="fas fa-edit"></i> Modifier
              </button>
              <button class="btn-card red" (click)="deleteSecretaire(secretaire.id)">
                <i class="fas fa-trash"></i> Supprimer
              </button>
            </div>

          </div>
        </div>

        <div *ngIf="!loading && filteredSecretaires.length === 0" class="empty-state">
          <i class="fas fa-user-tie"></i>
          <h3>Aucun(e) secrétaire trouvé(e)</h3>
          <p>Essayez de modifier vos critères de recherche</p>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ── Modal détail secrétaire approuvé(e) ──────────────────── -->
<div class="modal-overlay" *ngIf="selectedSecretaire" (click)="closeSecretaireDetail()">
  <div class="modal-content" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h2><i class="fas fa-user-tie"></i> Profil du/de la Secrétaire</h2>
      <button class="btn-close" (click)="closeSecretaireDetail()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="profile-section">
        <img [src]="getPhotoSrc(selectedSecretaire.photoBase64)"
             alt="Photo" class="profile-photo">
        <h3>{{ selectedSecretaire.prenom }} {{ selectedSecretaire.nom }}</h3>
        <p class="profile-specialite">{{ selectedSecretaire.specialite || 'Non renseignée' }}</p>
        <span class="badge badge-success">Secrétaire Approuvé(e)</span>
      </div>

      <div class="details-grid">
        <div class="detail-group">
          <h4><i class="fas fa-info-circle"></i> Informations Professionnelles</h4>
          <div class="detail-item">
            <label>Spécialité</label>
            <p>{{ selectedSecretaire.specialite || '—' }}</p>
          </div>
          <div class="detail-item">
            <label>Poste</label>
            <p>{{ selectedSecretaire.poste || '—' }}</p>
          </div>
          <div class="detail-item">
            <label>Département</label>
            <p>{{ selectedSecretaire.departement || '—' }}</p>
          </div>
          <div class="detail-item">
            <label>Adresse Hôpital</label>
            <p>{{ selectedSecretaire.adresseHopital || '—' }}</p>
          </div>
        </div>
        <div class="detail-group">
          <h4><i class="fas fa-address-book"></i> Coordonnées</h4>
          <div class="detail-item">
            <label>Email</label>
            <p>{{ selectedSecretaire.email }}</p>
          </div>
          <div class="detail-item">
            <label>Téléphone</label>
            <p>{{ selectedSecretaire.telephone }}</p>
          </div>
          <div class="detail-item">
            <label>Date d'inscription</label>
            <p>{{ formatDate(selectedSecretaire.dateInscription) }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeSecretaireDetail()">Fermer</button>
      <button class="btn-primary">
        <i class="fas fa-edit"></i> Modifier
      </button>
    </div>
  </div>
</div>

<!-- ── Modal profil secrétaire en attente ────────────────────── -->
<app-profil-detail
  *ngIf="selectedUserProfil"
  [user]="selectedUserProfil"
  (close)="closeProfilDetail()"
  (approve)="handleApprove($event)"
  (reject)="handleReject($event)">
</app-profil-detail>
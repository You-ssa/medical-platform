<div class="dashboard-layout">
  <app-sidebar></app-sidebar>

  <div class="main-content">
    <app-header></app-header>

    <div class="page-content">

      <!-- En-tête -->
      <div class="page-header">
        <div>
          <h1><i class="fas fa-user-md"></i> Gestion des Médecins</h1>
          <p class="page-subtitle">Gérez les médecins approuvés et les demandes en attente</p>
        </div>
      </div>

      <!-- Onglets -->
      <div class="admin-tabs">
        <button class="tab-btn"
          [class.active]="activeTab === 'en_attente'"
          (click)="activeTab = 'en_attente'; loadMedecinsEnAttente()">
          <i class="fas fa-hourglass-half"></i> En attente de validation
          <span class="badge badge-warning" *ngIf="medecinsEnAttente.length > 0">
            {{ medecinsEnAttente.length }}
          </span>
        </button>
        <button class="tab-btn"
          [class.active]="activeTab === 'approuves'"
          (click)="activeTab = 'approuves'; loadMedecins()">
          <i class="fas fa-user-check"></i> Médecins approuvés
          <span class="badge" *ngIf="medecins.length > 0">{{ medecins.length }}</span>
        </button>
      </div>

      <!-- ══════════════════════════════════════════════════════
           ONGLET : En attente
           ══════════════════════════════════════════════════════ -->
      <div *ngIf="activeTab === 'en_attente'" class="validation-section">

        <!-- Barre d'outils spécifique pour l'onglet en attente -->
        <div class="toolbar">
          <div class="search-box" style="flex: 1;">
            <i class="fas fa-search"></i>
            <input type="text" [(ngModel)]="searchTerm"
                   (input)="searchMedecins()"
                   placeholder="Rechercher un médecin en attente...">
          </div>
          
          <button class="btn-export" (click)="exportEnAttenteToCSV()" [disabled]="exportingEnAttente">
            <i class="fas fa-download"></i> Exporter en attente
            <span *ngIf="exportingEnAttente" class="spinner-small"></span>
          </button>

          <button class="btn-import" (click)="triggerFileInputEnAttente()" [disabled]="importingEnAttente">
            <i class="fas fa-upload"></i> Importer en attente
            <span *ngIf="importingEnAttente" class="spinner-small"></span>
          </button>

          <input #fileInputEnAttente type="file" accept=".csv, .xlsx, .xls" style="display: none" (change)="onFileSelectedEnAttente($event)">
        </div>

        <div *ngIf="loadingEnAttente" class="loading-container">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Chargement des demandes...</p>
        </div>

        <div *ngIf="!loadingEnAttente && errorEnAttente" class="error-banner">
          <i class="fas fa-exclamation-triangle"></i> {{ errorEnAttente }}
          <button (click)="loadMedecinsEnAttente()">Réessayer</button>
        </div>

        <div *ngIf="!loadingEnAttente && !errorEnAttente && medecinsEnAttente.length === 0"
             class="empty-state">
          <i class="fas fa-check-circle"></i>
          <h3>Aucune demande en attente</h3>
          <p>Tous les médecins ont été traités.</p>
        </div>

        <div *ngIf="!loadingEnAttente && medecinsEnAttente.length > 0" class="users-grid">
          <div *ngFor="let medecin of medecinsEnAttente" class="user-card">

            <div class="user-photo" (click)="showProfilDetail(medecin)">
              <img [src]="getPhotoSrc(medecin.photoBase64)" alt="Photo du médecin">
              <div class="photo-overlay"><i class="fas fa-eye"></i></div>
            </div>

            <div class="user-info">
              <h3>{{ medecin.prenom }} {{ medecin.nom }}</h3>
              <p><i class="fas fa-stethoscope"></i> {{ medecin.specialite || '—' }}</p>
              <p><i class="fas fa-id-card"></i> RPPS : {{ medecin.rpps || '—' }}</p>
              <p><i class="fas fa-envelope"></i> {{ medecin.email }}</p>
              <p><i class="fas fa-phone"></i> {{ medecin.telephone }}</p>
              <p><i class="fas fa-hospital"></i> {{ medecin.adresseHopital || '—' }}</p>
              <p><i class="fas fa-venus-mars"></i> Sexe : {{ medecin.sexe || '—' }}</p>
              <p class="date">
                <i class="fas fa-calendar"></i>
                Inscrit le {{ formatDate(medecin.dateInscription!) }}
              </p>
            </div>

            <div class="user-actions">
              <button class="btn-view" (click)="showProfilDetail(medecin)">
                <i class="fas fa-eye"></i> Voir le profil
              </button>
              <button class="btn-approve" (click)="approuverMedecin(medecin.id!)">
                <i class="fas fa-check"></i> Approuver
              </button>
              <button class="btn-reject" (click)="refuserMedecin(medecin.id!)">
                <i class="fas fa-times"></i> Refuser
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- ══════════════════════════════════════════════════════
           ONGLET : Approuvés
           ══════════════════════════════════════════════════════ -->
      <div *ngIf="activeTab === 'approuves'">

        <!-- Barre d'outils spécifique pour l'onglet approuvés -->
        <div class="toolbar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" [(ngModel)]="searchTerm"
                   (input)="searchMedecins()"
                   placeholder="Rechercher un médecin...">
          </div>
          
          <select class="filter-select" [(ngModel)]="filterSpecialite" (change)="filterBySpecialite()">
            <option value="">Toutes les spécialités</option>
            <option *ngFor="let spec of specialites" [value]="spec">{{ spec }}</option>
          </select>

          <button class="btn-export" (click)="exportApprouvesToCSV()" [disabled]="exportingApprouves">
            <i class="fas fa-download"></i> Exporter approuvés
            <span *ngIf="exportingApprouves" class="spinner-small"></span>
          </button>

          <button class="btn-import" (click)="triggerFileInputApprouves()" [disabled]="importingApprouves">
            <i class="fas fa-upload"></i> Importer approuvés
            <span *ngIf="importingApprouves" class="spinner-small"></span>
          </button>

          <input #fileInputApprouves type="file" accept=".csv, .xlsx, .xls" style="display: none" (change)="onFileSelectedApprouves($event)">
        </div>

        <div class="specialites-grid">
          <div *ngFor="let spec of (showAllSpecialites ? specialites : specialites.slice(0, 5))" class="specialite-card">
            <i class="fas fa-stethoscope"></i>
            <div>
              <p class="spec-name">{{ spec }}</p>
              <p class="spec-count">{{ getSpecialiteCount(spec) }} médecin{{ getSpecialiteCount(spec) > 1 ? 's' : '' }}</p>
            </div>
          </div>
        </div>

        <div class="specialites-actions" *ngIf="specialites.length > 5">
          <button class="btn-link" (click)="toggleSpecialites()">
            <i class="fas fa-chevron-{{ showAllSpecialites ? 'up' : 'down' }}"></i>
            {{ showAllSpecialites ? 'Voir moins' : 'Voir plus (' + (specialites.length - 5) + ' autres)' }}
          </button>
        </div>

        <div *ngIf="loading" class="loading-container">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Chargement des médecins...</p>
        </div>

        <div *ngIf="!loading" class="medecins-grid">
          <div *ngFor="let medecin of filteredMedecins" class="medecin-card">

            <div class="card-header">
              <img [src]="getPhotoSrc(medecin.photoBase64)"
                   alt="Photo du médecin" class="medecin-photo">
              <span class="status-badge active">Actif</span>
            </div>

            <div class="card-body">
              <h3>Dr. {{ medecin.prenom }} {{ medecin.nom }}</h3>
              <p class="specialite">
                <i class="fas fa-stethoscope"></i> {{ medecin.specialite || '—' }}
              </p>
              <div class="info-list">
                <div class="info-row"><i class="fas fa-id-card"></i> RPPS : {{ medecin.rpps || '—' }}</div>
                <div class="info-row"><i class="fas fa-envelope"></i> {{ medecin.email }}</div>
                <div class="info-row"><i class="fas fa-phone"></i> {{ medecin.telephone }}</div>
                <div class="info-row"><i class="fas fa-hospital"></i> {{ medecin.adresseHopital || '—' }}</div>
                <div class="info-row"><i class="fas fa-venus-mars"></i> Sexe : {{ medecin.sexe || '—' }}</div>
                <div class="info-row"><i class="fas fa-calendar"></i> Inscrit le {{ formatDate(medecin.dateInscription) }}</div>
              </div>
            </div>

            <div class="card-footer">
              <button class="btn-card blue" (click)="viewMedecin(medecin)">
                <i class="fas fa-eye"></i> Détails
              </button>
              <button class="btn-card green">
                <i class="fas fa-edit"></i> Modifier
              </button>
              <button class="btn-card red" (click)="deleteMedecin(medecin.id)">
                <i class="fas fa-trash"></i> Supprimer
              </button>
            </div>

          </div>
        </div>

        <div *ngIf="!loading && filteredMedecins.length === 0" class="empty-state">
          <i class="fas fa-user-md"></i>
          <h3>Aucun médecin trouvé</h3>
          <p>Essayez de modifier vos critères de recherche</p>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ── Modal détail médecin approuvé ────────────────────────── -->
<div class="modal-overlay" *ngIf="selectedMedecin" (click)="closeMedecinDetail()">
  <div class="modal-content" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h2><i class="fas fa-user-md"></i> Profil du Médecin</h2>
      <button class="btn-close" (click)="closeMedecinDetail()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-body">
      <div class="profile-section">
        <img [src]="getPhotoSrc(selectedMedecin.photoBase64)" alt="Photo" class="profile-photo">
        <h3>Dr. {{ selectedMedecin.prenom }} {{ selectedMedecin.nom }}</h3>
        <p class="profile-specialite">{{ selectedMedecin.specialite }}</p>
        <span class="badge badge-success">Médecin Approuvé</span>
      </div>

      <div class="details-grid">
        <div class="detail-group">
          <h4><i class="fas fa-info-circle"></i> Informations Professionnelles</h4>
          <div class="detail-item"><label>Numéro RPPS</label><p>{{ selectedMedecin.rpps || '—' }}</p></div>
          <div class="detail-item"><label>Spécialité</label><p>{{ selectedMedecin.specialite || '—' }}</p></div>
          <div class="detail-item"><label>Adresse Hôpital</label><p>{{ selectedMedecin.adresseHopital || '—' }}</p></div>
          <div class="detail-item"><label>Sexe</label><p>{{ selectedMedecin.sexe || '—' }}</p></div>
        </div>
        <div class="detail-group">
          <h4><i class="fas fa-address-book"></i> Coordonnées</h4>
          <div class="detail-item"><label>Email</label><p>{{ selectedMedecin.email }}</p></div>
          <div class="detail-item"><label>Téléphone</label><p>{{ selectedMedecin.telephone }}</p></div>
          <div class="detail-item"><label>Date d'inscription</label><p>{{ formatDate(selectedMedecin.dateInscription) }}</p></div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeMedecinDetail()">Fermer</button>
      <button class="btn-primary"><i class="fas fa-edit"></i> Modifier</button>
    </div>
  </div>
</div>

<!-- ── Modal profil médecin en attente ───────────────────────── -->
<app-profil-detail
  *ngIf="selectedUserProfil"
  [user]="selectedUserProfil"
  (close)="closeProfilDetail()"
  (approve)="handleApprove($event)"
  (reject)="handleReject($event)">
</app-profil-detail>